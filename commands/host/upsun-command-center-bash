#!/usr/bin/env bash
#ddev-generated
#annertech-ddev

# Bash version of Upsun Command Centre
# Converted to bash automatically with Claude Code.
# We'll chose which one will be maintained further.

## Description: Upsun Command Centre (ssh, uli, resume, activities, disk) - Bash version
## Usage: upsun-command-center-bash [ACTION] [PROJECT] [ENVIRONMENT]
## Example: "ddev upsun-command-center-bash" (interactive) or "ddev uccb run_log_checker_goaccess myproject main"
## Aliases: upbash, uccb

# Colours
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo_red() { echo -e "${RED}$1${NC}" >&2; }
echo_green() { echo -e "${GREEN}$1${NC}" >&2; }
echo_yellow() { echo -e "${YELLOW}$1${NC}" >&2; }

# Menu options
OPTIONS=(
    "1. Drush ULI"
    "2. Activities"
    "3. Running activity"
    "4. SSH"
    "5. Resume Environment"
    "6. Disk Allocation Helper (beta)"
    "7. Log-checker (beta)"
    "8. Log-checker with goaccess (beta)"
    "9. Backup Environment"
)

# Get current project ID from .ddev/config.yaml
get_current_project_id() {
    if [[ -f ".ddev/config.yaml" ]]; then
        grep -oP 'PLATFORM_PROJECT[=:]\s*\K[^\s\n]+' .ddev/config.yaml 2>/dev/null
    fi
}

# FZF select helper
fzf_select() {
    local header="$1"
    local query="$2"
    local cmd="fzf --reverse --height=50% --header=${header} -1"
    if [[ -n "$query" ]]; then
        cmd="$cmd --query=${query}"
    fi
    eval "$cmd"
}

# Select action
select_action() {
    echo_green "Start typing to select an action"
    printf '%s\n' "${OPTIONS[@]}" | fzf --reverse --height=50% --header="Action" -1
}

# Select project
select_project() {
    echo_green "Start typing to select a project"
    local current_project
    current_project=$(get_current_project_id)

    local projects
    projects=$(ddev exec upsun project:list --no-header --columns=id,title --format=tsv --count=0)

    if [[ -z "$projects" ]]; then
        echo_red "Failed to get project list"
        return 1
    fi

    # Move current project to top and mark it
    if [[ -n "$current_project" ]]; then
        local matching
        local others
        matching=$(echo "$projects" | grep "^${current_project}" | sed 's/$/ (current)/')
        others=$(echo "$projects" | grep -v "^${current_project}")
        projects=$(printf '%s\n%s' "$matching" "$others" | grep -v '^$')
    fi

    echo "$projects" | fzf --reverse --height=50% --header="id              Project" -1
}

# Select environment
select_environment() {
    local project_id="$1"
    echo_green "Start typing to select an environment"

    local environments
    environments=$(ddev exec upsun environment:list --project="${project_id}" --no-header --columns=id --format=tsv)

    if [[ -z "$environments" ]]; then
        echo_red "Failed to get environment list"
        return 1
    fi

    echo "$environments" | fzf --reverse --height=50% --header="Environment" -1
}

# Run resume
run_resume() {
    local project_id="$1"
    local project_name="$2"
    echo_green "${project_name} Selected"
    echo_yellow "Starting resume process..."
    ddev exec upsun environment:resume --project="${project_id}"
}

# Run ULI
run_uli() {
    local project_id="$1"
    local project_name="$2"
    local environment_id="$3"
    echo_green "${project_name} / ${environment_id} Selected"
    echo_yellow "Getting URL..."
    ddev exec upsun drush uli --project="${project_id}" -e "${environment_id}"
}

# Run SSH
run_ssh() {
    local project_id="$1"
    local project_name="$2"
    echo_green "${project_name} Selected"
    echo_yellow "Connecting via SSH..."
    ddev exec upsun ssh --project="${project_id}"
}

# Run activities
run_activities() {
    local project_id="$1"
    local project_name="$2"
    echo_green "${project_name} Selected"
    echo_yellow "Fetching activities..."
    ddev exec upsun act --project="${project_id}"
}

# Run activity in progress
run_activity_in_progress() {
    local project_id="$1"
    local project_name="$2"
    local environment_id="$3"
    echo_green "${project_name} / ${environment_id} Selected"
    echo_yellow "Fetching running activity log..."
    ddev exec upsun act:log --state=in_progress --project="${project_id}" -e "${environment_id}"
}

# Run disk helper
run_disk_helper() {
    local project_id="$1"
    local project_name="$2"
    echo_green "${project_name} Selected"

    echo ""
    echo "Currently used and assigned disk space:"
    ddev exec upsun disk -1 --columns Service,Used,Limit --project="${project_id}"

    # Get disk bytes for services
    local web db solr total_assigned total_available
    web=$(ddev exec upsun disk -1 --columns Limit -s app --bytes --no-header --format=plain --project="${project_id}" 2>/dev/null | tr -d '[:space:]')
    db=$(ddev exec upsun disk -1 --columns Limit -s mysqldb --bytes --no-header --format=plain --project="${project_id}" 2>/dev/null | tr -d '[:space:]')
    solr=$(ddev exec upsun disk -1 --columns Limit -s solrsearch --bytes --no-header --format=plain --project="${project_id}" 2>/dev/null | tr -d '[:space:]')

    web=${web:-0}
    db=${db:-0}
    solr=${solr:-0}
    total_assigned=$((web + db + solr))

    # Get total available storage
    total_available=$(ddev exec upsun project:info subscription.storage --project="${project_id}" 2>/dev/null | tr -d '[:space:]')
    total_available=${total_available:-0}

    echo ""
    echo "Total assigned (app+mysqldb+solrsearch):"
    numfmt --to iec --format "%3.2f" "$total_assigned"

    echo ""
    echo "Total storage available in project:"
    numfmt --from-unit=1048576 --to iec --format="%3.2f" "$total_available"

    echo_yellow ""
    echo_yellow "WARNING: command uses hardcoded values for service totals. Verify numbers with table above!"
    echo ""
}

# Run log checker
run_log_checker() {
    local project_id="$1"
    local project_name="$2"
    local environment_id="$3"
    echo_green "${project_name} / ${environment_id} Selected"
    echo_yellow "Analyzing access logs (top 10 requests)..."
    ddev exec upsun ssh --project="${project_id}" -e "${environment_id}" -- \
        "tail -n 5000 /var/log/access.log | cut -d' ' -f 12- | sort | uniq -c | sort -nr | head -n 10"
}

# Run log checker with goaccess
run_log_checker_goaccess() {
    local project_id="$1"
    local project_name="$2"
    local environment_id="$3"
    echo_green "${project_name} / ${environment_id} Selected"
    echo_yellow "Fetching logs and loading in goaccess..."
    ddev exec upsun ssh --project="${project_id}" -e "${environment_id}" -- "cat /var/log/access.log" | \
        goaccess --log-format=COMBINED -
}

# Run backup
run_backup() {
    local project_id="$1"
    local project_name="$2"
    local environment_id="$3"
    echo_green "${project_name} / ${environment_id} Selected"
    echo_yellow "Creating backup..."
    ddev exec upsun backup:create --project="${project_id}" -e "${environment_id}"
}

# Find project by name or ID
find_project() {
    local search_term="$1"
    local projects
    projects=$(ddev exec upsun project:list --no-header --columns=id,title --format=tsv --count=0)

    # Try exact match on ID first
    local match
    match=$(echo "$projects" | grep "^${search_term}[[:space:]]" | head -n1)

    # If no match, try case-insensitive match on title
    if [[ -z "$match" ]]; then
        match=$(echo "$projects" | grep -i "[[:space:]]${search_term}" | head -n1)
    fi

    echo "$match"
}

# Main function
main() {
    local action_arg="$1"
    local project_arg="$2"
    local env_arg="$3"

    # Show banner only in interactive mode
    if [[ -z "$action_arg" ]]; then
        echo_green "
██╗   ██╗██████╗ ███████╗██╗   ██╗███╗   ██╗
██║   ██║██╔══██╗██╔════╝██║   ██║████╗  ██║
██║   ██║██████╔╝███████╗██║   ██║██╔██╗ ██║
██║   ██║██╔═══╝ ╚════██║██║   ██║██║╚██╗██║
╚██████╔╝██║     ███████║╚██████╔╝██║ ╚████║
 ╚═════╝ ╚═╝     ╚══════╝ ╚═════╝ ╚═╝  ╚═══╝

 ██████╗ ██████╗ ███╗   ███╗███╗   ███╗ █████╗ ███╗   ██╗██████╗      ██████╗███████╗███╗   ██╗████████╗██████╗ ███████╗
██╔════╝██╔═══██╗████╗ ████║████╗ ████║██╔══██╗████╗  ██║██╔══██╗    ██╔════╝██╔════╝████╗  ██║╚══██╔══╝██╔══██╗██╔════╝
██║     ██║   ██║██╔████╔██║██╔████╔██║███████║██╔██╗ ██║██║  ██║    ██║     █████╗  ██╔██╗ ██║   ██║   ██████╔╝█████╗
██║     ██║   ██║██║╚██╔╝██║██║╚██╔╝██║██╔══██║██║╚██╗██║██║  ██║    ██║     ██╔══╝  ██║╚██╗██║   ██║   ██╔══██╗██╔══╝
╚██████╗╚██████╔╝██║ ╚═╝ ██║██║ ╚═╝ ██║██║  ██║██║ ╚████║██████╔╝    ╚██████╗███████╗██║ ╚████║   ██║   ██║  ██║███████╗
 ╚═════╝ ╚═════╝ ╚═╝     ╚═╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝╚═════╝      ╚═════╝╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚═╝  ╚═╝╚══════╝
"
        echo "                                      by Annertech and Bill Seremetis"
        echo ""
    fi

    # Select or use provided action
    local action_label
    if [[ -n "$action_arg" ]]; then
        # Map function name to action label
        case "$action_arg" in
            run_ssh) action_label="SSH" ;;
            run_uli) action_label="Drush ULI" ;;
            run_resume) action_label="Resume Environment" ;;
            run_activities) action_label="Activities" ;;
            run_activity_in_progress) action_label="Running activity" ;;
            run_disk_helper) action_label="Disk Allocation Helper (beta)" ;;
            run_log_checker) action_label="Log-checker (beta)" ;;
            run_log_checker_goaccess) action_label="Log-checker with goaccess (beta)" ;;
            run_backup) action_label="Backup Environment" ;;
            *)
                echo_red "Unknown action: $action_arg"
                echo_yellow "Available actions: run_ssh, run_uli, run_resume, run_activities, run_activity_in_progress, run_disk_helper, run_log_checker, run_log_checker_goaccess, run_backup"
                exit 1
                ;;
        esac
    else
        local action_selection
        action_selection=$(select_action)
        if [[ -z "$action_selection" ]]; then
            echo_red "Nothing selected... Exiting"
            exit 0
        fi
        action_label=$(echo "$action_selection" | sed 's/^[0-9]*\. //')
    fi

    # Select or use provided project
    local project_id project_name
    if [[ -n "$project_arg" ]]; then
        local project_selection
        project_selection=$(find_project "$project_arg")
        if [[ -z "$project_selection" ]]; then
            echo_red "Project not found: $project_arg"
            exit 1
        fi
        project_id=$(echo "$project_selection" | cut -f1)
        project_name=$(echo "$project_selection" | cut -f2)
        [[ -z "$project_name" ]] && project_name="$project_id"
    else
        local project_selection
        project_selection=$(select_project)
        if [[ -z "$project_selection" ]]; then
            echo_red "Nothing selected... Exiting"
            exit 0
        fi
        project_id=$(echo "$project_selection" | cut -f1 | sed 's/ (current)$//')
        project_name=$(echo "$project_selection" | cut -f2 | sed 's/ (current)$//')
        [[ -z "$project_name" ]] && project_name="$project_id"
    fi

    # Execute selected action
    case "$action_label" in
        "SSH")
            run_ssh "$project_id" "$project_name"
            ;;
        "Drush ULI")
            local env
            if [[ -n "$env_arg" ]]; then
                env="$env_arg"
            else
                env=$(select_environment "$project_id")
                if [[ -z "$env" ]]; then
                    echo_red "No environment selected... Exiting"
                    exit 0
                fi
            fi
            run_uli "$project_id" "$project_name" "$env"
            ;;
        "Resume Environment")
            run_resume "$project_id" "$project_name"
            ;;
        "Activities")
            run_activities "$project_id" "$project_name"
            ;;
        "Running activity")
            local env
            if [[ -n "$env_arg" ]]; then
                env="$env_arg"
            else
                env=$(select_environment "$project_id")
                if [[ -z "$env" ]]; then
                    echo_red "No environment selected... Exiting"
                    exit 0
                fi
            fi
            run_activity_in_progress "$project_id" "$project_name" "$env"
            ;;
        "Disk Allocation Helper (beta)")
            run_disk_helper "$project_id" "$project_name"
            ;;
        "Log-checker (beta)")
            local env
            if [[ -n "$env_arg" ]]; then
                env="$env_arg"
            else
                env=$(select_environment "$project_id")
                if [[ -z "$env" ]]; then
                    echo_red "No environment selected... Exiting"
                    exit 0
                fi
            fi
            run_log_checker "$project_id" "$project_name" "$env"
            ;;
        "Log-checker with goaccess (beta)")
            local env
            if [[ -n "$env_arg" ]]; then
                env="$env_arg"
            else
                env=$(select_environment "$project_id")
                if [[ -z "$env" ]]; then
                    echo_red "No environment selected... Exiting"
                    exit 0
                fi
            fi
            run_log_checker_goaccess "$project_id" "$project_name" "$env"
            ;;
        "Backup Environment")
            local env
            if [[ -n "$env_arg" ]]; then
                env="$env_arg"
            else
                env=$(select_environment "$project_id")
                if [[ -z "$env" ]]; then
                    echo_red "No environment selected... Exiting"
                    exit 0
                fi
            fi
            run_backup "$project_id" "$project_name" "$env"
            ;;
        *)
            echo_red "Unknown action: $action_label"
            exit 1
            ;;
    esac
}

main "$@"
