#!/usr/bin/env python3
#ddev-generated
#annertech-ddev

# Ported to python from previous separate bash scripts and added a main menu.

## Description: Upsun Command Centre (ssh, uli, resume, activities, disk) - Python version
## Usage: upsun-command-center-python
## Example: "ddev upsun-command-center-python"
## Aliases: uptools, uptool, platform-ulitool, ulitool, platform-resume, uccp

import subprocess
import sys
import os
import re

# Menu options
OPTIONS = {
    "Drush ULI": "uli",
    "Activities": "act",
    "Running activity": "act-in-progress",
    "SSH": "ssh",
    "Resume Environment": "resume",
    "Disk Allocation Helper (beta)": "disk",
    "Log-checker (beta)": "logcheck",
    "Log-checker with goaccess (beta)": "logcheck-goaccess",
}

# Colours
RED = '\033[0;31m'
GREEN = '\033[0;32m'
YELLOW = '\033[1;33m'
NC = '\033[0m'

def echo_red(msg):
    print(f"{RED}{msg}{NC}")

def echo_green(msg):
    print(f"{GREEN}{msg}{NC}")

def echo_yellow(msg):
    print(f"{YELLOW}{msg}{NC}")

def get_current_project_id():
    """Get the current project ID from .ddev/config.yaml."""
    config_path = ".ddev/config.yaml"
    if not os.path.exists(config_path):
        return None
    try:
        with open(config_path, 'r') as f:
            content = f.read()
            match = re.search(r'PLATFORM_PROJECT[=:][\s]*([^\s\n]+)', content)
            if match:
                return match.group(1)
    except (IOError, OSError):
        pass
    return None

def fzf_select(items, header, query=None):
    """Use fzf to select from a list of items."""
    try:
        cmd = ["fzf", "--reverse", "--height=50%", f"--header={header}", "-1"]
        if query:
            cmd.extend(["--query", query])
        fzf = subprocess.Popen(
            cmd,
            stdin=subprocess.PIPE,
            stdout=subprocess.PIPE,
            text=True
        )
        stdout, _ = fzf.communicate(input="\n".join(items))
        return stdout.strip() if fzf.returncode == 0 else None
    except FileNotFoundError:
        echo_red("fzf is not installed")
        return None

def select_action():
    """Use fzf to select an action."""
    echo_green("Start typing to select an action")
    # Add numeric IDs to options
    numbered_options = [f"{i+1}. {opt}" for i, opt in enumerate(OPTIONS.keys())]
    selection = fzf_select(numbered_options, "Action")
    if selection:
        # Remove the numeric prefix to get the original option name
        return selection.split(". ", 1)[1] if ". " in selection else selection
    return None

def select_project():
    """Use fzf to select a Platform.sh project."""
    echo_green("Start typing to select a project")
    current_project = get_current_project_id()
    try:
        result = subprocess.run(
            ["ddev", "exec", "upsun", "project:list", "--no-header",
             "--columns=id,title", "--format=tsv", "--count=0"],
            capture_output=True, text=True, check=True
        )
        projects = result.stdout.strip().split("\n")
        # Move current project to top of list and mark it
        if current_project:
            matching = [f"{p} (current)" for p in projects if p.startswith(current_project)]
            others = [p for p in projects if not p.startswith(current_project)]
            projects = matching + others
        return fzf_select(projects, "id              Project")
    except subprocess.CalledProcessError:
        echo_red("Failed to get project list")
        return None

def select_environment(project_id):
    """Use fzf to select an environment for a project."""
    echo_green("Start typing to select an environment")
    try:
        result = subprocess.run(
            ["ddev", "exec", "upsun", "environment:list", f"--project={project_id}",
             "--no-header", "--columns=id", "--format=tsv"],
            capture_output=True, text=True, check=True
        )
        environments = result.stdout.strip().split("\n")
        return fzf_select(environments, "Environment")
    except subprocess.CalledProcessError:
        echo_red("Failed to get environment list")
        return None

def run_resume(project_id, project_name):
    """Resume a Platform.sh environment."""
    echo_green(f"{project_name} Selected")
    echo_yellow("Starting resume process...")
    subprocess.run(["ddev", "exec", "upsun", "environment:resume", f"--project={project_id}"])

def run_uli(project_id, project_name, environment_id):
    """Get drush ULI for a Platform.sh project."""
    echo_green(f"{project_name} / {environment_id} Selected")
    echo_yellow("Getting URL...")
    subprocess.run(["ddev", "exec", "upsun", "drush", "uli", f"--project={project_id}", "-e", environment_id])

def run_ssh(project_id, project_name):
    """SSH into an Upsun project."""
    echo_green(f"{project_name} Selected")
    echo_yellow("Connecting via SSH...")
    subprocess.run(["ddev", "exec", "upsun", "ssh", f"--project={project_id}"])

def run_activities(project_id, project_name):
    """Show activities for an Upsun project."""
    echo_green(f"{project_name} Selected")
    echo_yellow("Fetching activities...")
    subprocess.run(["ddev", "exec", "upsun", "act", f"--project={project_id}"])

def run_activity_in_progress(project_id, project_name, environment_id):
    """Show running activity log for an Upsun project."""
    echo_green(f"{project_name} / {environment_id} Selected")
    echo_yellow("Fetching running activity log...")
    subprocess.run(["ddev", "exec", "upsun", "act:log", "--state=in_progress", f"--project={project_id}", "-e", environment_id])

def run_disk_helper(project_id, project_name):
    """Show disk usage information for a Platform.sh project."""
    echo_green(f"{project_name} Selected")

    print("\nCurrently used and assigned disk space:")
    subprocess.run(["ddev", "exec", "upsun", "disk", "-1", "--columns", "Service,Used,Limit", f"--project={project_id}"])

    def get_disk_bytes(service):
        """Get disk limit in bytes for a service."""
        try:
            result = subprocess.run(
                ["ddev", "exec", "upsun", "disk", "-1", "--columns", "Limit",
                 "-s", service, "--bytes", "--no-header", "--format=plain", f"--project={project_id}"],
                capture_output=True, text=True, check=True
            )
            return int(result.stdout.strip()) if result.stdout.strip() else 0
        except (subprocess.CalledProcessError, ValueError):
            return 0

    web = get_disk_bytes("app")
    db = get_disk_bytes("mysqldb")
    solr = get_disk_bytes("solrsearch")
    total_assigned = web + db + solr

    # Get total available storage
    try:
        result = subprocess.run(
            ["ddev", "exec", "upsun", "project:info", "subscription.storage", f"--project={project_id}"],
            capture_output=True, text=True, check=True
        )
        total_available = int(result.stdout.strip()) if result.stdout.strip() else 0
    except (subprocess.CalledProcessError, ValueError):
        total_available = 0

    # Format and display totals
    print("\nTotal assigned (app+mysqldb+solrsearch):")
    result = subprocess.run(["numfmt", "--to", "iec", "--format", "%3.2f", str(total_assigned)], capture_output=True, text=True)
    print(result.stdout.strip())

    print("\nTotal storage available in project:")
    result = subprocess.run(["numfmt", "--from-unit=1048576", "--to", "iec", "--format=%3.2f", str(total_available)], capture_output=True, text=True)
    print(result.stdout.strip())

    echo_yellow("\nWARNING: command uses hardcoded values for service totals. Verify numbers with table above!\n")

def run_log_checker(project_id, project_name, environment_id):
    """Analyze access logs for an Upsun project."""
    echo_green(f"{project_name} / {environment_id} Selected")
    echo_yellow("Analyzing access logs (top 10 requests)...")
    subprocess.run([
        "ddev", "exec", "upsun", "ssh", f"--project={project_id}", "-e", environment_id, "--",
        "tail -n 5000 /var/log/access.log | cut -d' ' -f 12- | sort | uniq -c | sort -nr | head -n 10"
    ])

def run_log_checker_goaccess(project_id, project_name, environment_id):
    """Load access logs in goaccess on the host."""
    echo_green(f"{project_name} / {environment_id} Selected")
    echo_yellow("Fetching logs and loading in goaccess...")
    # Fetch logs via upsun ssh and pipe to goaccess
    upsun = subprocess.Popen(
        ["ddev", "exec", "upsun", "ssh", f"--project={project_id}", "-e", environment_id, "--", "cat /var/log/access.log"],
        stdout=subprocess.PIPE
    )
    subprocess.run(["goaccess", "--log-format=COMBINED", "-"], stdin=upsun.stdout)
    upsun.wait()

def main():
    # Banner
    echo_green("""
██╗   ██╗██████╗ ███████╗██╗   ██╗███╗   ██╗
██║   ██║██╔══██╗██╔════╝██║   ██║████╗  ██║
██║   ██║██████╔╝███████╗██║   ██║██╔██╗ ██║
██║   ██║██╔═══╝ ╚════██║██║   ██║██║╚██╗██║
╚██████╔╝██║     ███████║╚██████╔╝██║ ╚████║
 ╚═════╝ ╚═╝     ╚══════╝ ╚═════╝ ╚═╝  ╚═══╝

 ██████╗ ██████╗ ███╗   ███╗███╗   ███╗ █████╗ ███╗   ██╗██████╗      ██████╗███████╗███╗   ██╗████████╗██████╗ ███████╗
██╔════╝██╔═══██╗████╗ ████║████╗ ████║██╔══██╗████╗  ██║██╔══██╗    ██╔════╝██╔════╝████╗  ██║╚══██╔══╝██╔══██╗██╔════╝
██║     ██║   ██║██╔████╔██║██╔████╔██║███████║██╔██╗ ██║██║  ██║    ██║     █████╗  ██╔██╗ ██║   ██║   ██████╔╝█████╗
██║     ██║   ██║██║╚██╔╝██║██║╚██╔╝██║██╔══██║██║╚██╗██║██║  ██║    ██║     ██╔══╝  ██║╚██╗██║   ██║   ██╔══██╗██╔══╝
╚██████╗╚██████╔╝██║ ╚═╝ ██║██║ ╚═╝ ██║██║  ██║██║ ╚████║██████╔╝    ╚██████╗███████╗██║ ╚████║   ██║   ██║  ██║███████╗
 ╚═════╝ ╚═════╝ ╚═╝     ╚═╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝╚═════╝      ╚═════╝╚══════╝╚═╝  ╚═══╝   ╚═╝   ╚═╝  ╚═╝╚══════╝
""")
    print("                                      by Annertech and Bill Seremetis")
    print()

    # Select action using fzf
    action_label = select_action()
    if not action_label:
        echo_red("Nothing selected... Exiting")
        sys.exit(0)

    action = OPTIONS[action_label]

    # Select project using fzf
    project = select_project()
    if not project:
        echo_red("Nothing selected... Exiting")
        sys.exit(0)

    # Parse project info
    parts = project.split('\t')
    project_id = parts[0]
    project_name = parts[1] if len(parts) > 1 else project_id

    # Execute selected action
    if action == "ssh":
        run_ssh(project_id, project_name)
    elif action == "uli":
        env = select_environment(project_id)
        if not env:
            echo_red("No environment selected... Exiting")
            sys.exit(0)
        environment_id = env.split('\t')[0].replace(" (default)", "")
        run_uli(project_id, project_name, environment_id)
    elif action == "resume":
        run_resume(project_id, project_name)
    elif action == "act":
        run_activities(project_id, project_name)
    elif action == "act-in-progress":
        env = select_environment(project_id)
        if not env:
            echo_red("No environment selected... Exiting")
            sys.exit(0)
        environment_id = env.split('\t')[0]
        run_activity_in_progress(project_id, project_name, environment_id)
    elif action == "disk":
        run_disk_helper(project_id, project_name)
    elif action == "logcheck":
        env = select_environment(project_id)
        if not env:
            echo_red("No environment selected... Exiting")
            sys.exit(0)
        environment_id = env.split('\t')[0]
        run_log_checker(project_id, project_name, environment_id)
    elif action == "logcheck-goaccess":
        env = select_environment(project_id)
        if not env:
            echo_red("No environment selected... Exiting")
            sys.exit(0)
        environment_id = env.split('\t')[0]
        run_log_checker_goaccess(project_id, project_name, environment_id)

if __name__ == "__main__":
    main()
