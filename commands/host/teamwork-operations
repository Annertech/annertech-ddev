#!/usr/bin/env bash
#ddev-generated
#annertech-ddev

## Description: Teamwork Operations Centre (open-issue, comment, timelog)
## Usage: teamwork-operations
## Example: "ddev teamwork-operations"
## Aliases: tw

# Colours
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo_red() { echo -e "${RED}$1${NC}" >&2; }
echo_green() { echo -e "${GREEN}$1${NC}" >&2; }
echo_yellow() { echo -e "${YELLOW}$1${NC}" >&2; }

# Menu options
OPTIONS=(
    "1. Open Issue"
    "2. Post Comment"
    "3. Log Time"
)

# Select action
select_action() {
    echo_green "Start typing to select an action"
    printf '%s\n' "${OPTIONS[@]}" | fzf --reverse --height=50% --header="Action"
}

# Main function
main() {
    # Banner
    echo_green "
████████╗███████╗ █████╗ ███╗   ███╗██╗    ██╗ ██████╗ ██████╗ ██╗  ██╗
╚══██╔══╝██╔════╝██╔══██╗████╗ ████║██║    ██║██╔═══██╗██╔══██╗██║ ██╔╝
   ██║   █████╗  ███████║██╔████╔██║██║ █╗ ██║██║   ██║██████╔╝█████╔╝
   ██║   ██╔══╝  ██╔══██║██║╚██╔╝██║██║███╗██║██║   ██║██╔══██╗██╔═██╗
   ██║   ███████╗██║  ██║██║ ╚═╝ ██║╚███╔███╔╝╚██████╔╝██║  ██║██║  ██╗
   ╚═╝   ╚══════╝╚═╝  ╚═╝╚═╝     ╚═╝ ╚══╝╚══╝  ╚═════╝ ╚═╝  ╚═╝╚═╝  ╚═╝

 ██████╗ ██████╗ ███████╗██████╗  █████╗ ████████╗██╗ ██████╗ ███╗   ██╗███████╗
██╔═══██╗██╔══██╗██╔════╝██╔══██╗██╔══██╗╚══██╔══╝██║██╔═══██╗████╗  ██║██╔════╝
██║   ██║██████╔╝█████╗  ██████╔╝███████║   ██║   ██║██║   ██║██╔██╗ ██║███████╗
██║   ██║██╔═══╝ ██╔══╝  ██╔══██╗██╔══██║   ██║   ██║██║   ██║██║╚██╗██║╚════██║
╚██████╔╝██║     ███████╗██║  ██║██║  ██║   ██║   ██║╚██████╔╝██║ ╚████║███████║
 ╚═════╝ ╚═╝     ╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝   ╚═╝   ╚═╝ ╚═════╝ ╚═╝  ╚═══╝╚══════╝
"
    echo "                                by Annertech and Bill Seremetis"
    echo ""

    # Check for task ID upfront and offer to create branch if needed
    branch_name=$(git rev-parse --abbrev-ref HEAD)
    if [[ ! $branch_name =~ T-([0-9]+) ]]; then
        echo_yellow "No task ID found in current branch (${branch_name})."
        echo ""

        # Branch options menu
        BRANCH_OPTIONS=(
            "1. Create a new branch with a task ID"
            "2. Go to previous branch (git checkout -)"
            "0. Exit"
        )

        echo_green "Select an option"
        branch_choice=$(printf '%s\n' "${BRANCH_OPTIONS[@]}" | fzf --reverse --height=50% --header="No task branch found")

        if [[ -z "$branch_choice" ]]; then
            echo_red "Nothing selected... Exiting"
            exit 0
        fi

        # Extract choice number
        choice_num=$(echo "$branch_choice" | sed 's/^\([0-9]*\)\..*/\1/')

        echo ""
        case "$choice_num" in
            1)
                ddev branch
                echo ""
                ;;
            2)
                echo_green "Switching to previous branch..."
                git checkout -
                echo ""
                # Check if the new branch has a task ID
                branch_name=$(git rev-parse --abbrev-ref HEAD)
                if [[ $branch_name =~ T-([0-9]+) ]]; then
                    echo_green "Now on branch with task: T-${BASH_REMATCH[1]}"
                else
                    echo_yellow "Previous branch (${branch_name}) also has no task ID."
                    echo_yellow "You'll need to enter task IDs manually."
                fi
                echo ""
                ;;
            0)
                echo_red "Exiting."
                exit 0
                ;;
            *)
                echo_red "Invalid choice. Exiting."
                exit 1
                ;;
        esac
    fi

    # Select action
    local action_selection
    action_selection=$(select_action)
    if [[ -z "$action_selection" ]]; then
        echo_red "Nothing selected... Exiting"
        exit 0
    fi

    # Extract action from selection (remove number prefix)
    local action_label
    action_label=$(echo "$action_selection" | sed 's/^[0-9]*\. //')

    # Execute selected action
    case "$action_label" in
        "Open Issue")
            ddev open-issue
            ;;
        "Post Comment")
            echo_green "Post Comment to Task"
            echo ""
            ddev comment
            ;;
        "Log Time")
            echo_green "Log Time to Task"
            echo ""
            ddev timelog
            ;;
        *)
            echo_red "Unknown action: $action_label"
            exit 1
            ;;
    esac
}

main
