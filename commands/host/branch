#!/usr/bin/env python3
#ddev-generated

## Description: Create a git branch from a Teamwork url
## Usage: branch
## Example: ddev branch

# Given a Teamwork url, and optional name, creates a new branch
#
# Prompts for a Teamwork url, and then for an optional branch name. Given the
# following url and string:
#
# - https://projects.YOURCOMPANY.com/app/tasks/17360561
# - qa_rework
#
# the script will create a git branch with the following name:
#
# 17360561_2024_w37__qa_rework
#
# Where:
#
# - 17360561 is the Teamwork card identifier
# - 2024 is the year
# - w37 is the current week
# - qa_rework is the branch name provided
#

from urllib.parse import urlparse
import datetime
import subprocess

# Function to extract the ID from the URL
def extract_last_part(url):
    path = urlparse(url).path
    last_part = path.split('/')[-1]
    return last_part

# Get current year and month
current_year = datetime.datetime.now().year
current_month = datetime.datetime.now().month

# Main script
def main():
    url = input("Enter the URL: ").strip()
    custom_text = input("Enter custom text: ").strip()

    # Replace spaces with hyphens and make it Git-friendly
    custom_text = custom_text.replace(" ", "_")

    # Extract the last part (ID) from the URL
    last_part = extract_last_part(url)

    # Create the branch name in the format YEAR/MONTH/ID-description
    branch_name = f"{current_year}/{current_month:02}/T-{last_part}__{custom_text}"

    # Ensure only valid characters are in the branch name
    branch_name = "".join(c for c in branch_name if c.isalnum() or c in ['-', '_', '.', '/'])

    # Print the branch name
    print(f"Creating new Git branch: {branch_name}")

    # Execute git command to create and switch to the new branch
    try:
        subprocess.run(["git", "checkout", "-b", branch_name], check=True)
        print(f"Successfully created and switched to branch '{branch_name}'")
    except subprocess.CalledProcessError as e:
        print(f"Error creating the branch: {e}")

if __name__ == "__main__":
    main()

