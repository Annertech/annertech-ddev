#!/usr/bin/env bash
#ddev-generated
#annertech-ddev

## Description: AI Prompts Operations Centre
## Usage: ai-prompts
## Example: "ddev ai-prompts"
## Aliases: ai

# Colours
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo_red() { echo -e "${RED}$1${NC}" >&2; }
echo_green() { echo -e "${GREEN}$1${NC}" >&2; }
echo_yellow() { echo -e "${YELLOW}$1${NC}" >&2; }

# Menu options
OPTIONS=(
    "1. BackstopJS Init"
)

# AI Agent options
AI_AGENTS=(
    "1. Gemini"
    "2. Copilot"
    "3. Claude"
)

# Select action
select_action() {
    echo_green "Start typing to select a prompt"
    printf '%s\n' "${OPTIONS[@]}" | fzf --reverse --height=50% --header="AI Prompt"
}

# Select AI agent
select_agent() {
    echo_green "Select AI agent"
    printf '%s\n' "${AI_AGENTS[@]}" | fzf --reverse --height=50% --header="AI Agent"
}

# BackstopJS Init function
backstop_init() {
    # Extract environment variables from DDEV container
    TEST_DOMAIN=$(ddev exec env | grep -E '^DDEV_PRIMARY_URL=' | cut -d= -f2)
    REFERENCE_DOMAIN=$(ddev exec env | grep -E '^STAGE_FILE_PROXY_URL=' | cut -d= -f2)

    # Validate variables
    if [ -z "$TEST_DOMAIN" ]; then
        echo_red "Error: DDEV_PRIMARY_URL not found"
        exit 1
    fi

    if [ -z "$REFERENCE_DOMAIN" ]; then
        echo_red "Error: STAGE_FILE_PROXY_URL not found"
        exit 1
    fi

    # Change to tests/backstop directory
    if ! cd tests/backstop 2>/dev/null; then
        echo_red "Error: tests/backstop directory not found"
        exit 1
    fi

    # Select AI agent
    local agent_selection
    agent_selection=$(select_agent)
    if [[ -z "$agent_selection" ]]; then
        echo_red "No agent selected... Exiting"
        exit 0
    fi

    # Extract agent label
    local agent_label
    agent_label=$(echo "$agent_selection" | sed 's/^[0-9]*\. //')

    echo_green "Initializing BackstopJS configuration with ${agent_label}..."
    echo ""

    # Read and populate the prompt
    local prompt_content
    prompt_content=$(sed -e "s|__TEST_DOMAIN__|$TEST_DOMAIN|g" \
        -e "s|__REFERENCE_DOMAIN__|$REFERENCE_DOMAIN|g" \
        ../../.ddev/scripts/prompts/backstop-init.md)

    # Call the selected AI agent
    case "$agent_label" in
        "Gemini")
            gemini "$prompt_content"
            ;;
        "Copilot")
            copilot "$prompt_content"
            ;;
        "Claude")
            claude "$prompt_content"
            ;;
        *)
            echo_red "Unknown agent: $agent_label"
            exit 1
            ;;
    esac
}

# Main function
main() {
    # Banner
    echo_green "
 █████╗ ██╗    ██████╗ ██████╗  ██████╗ ███╗   ███╗██████╗ ████████╗███████╗
██╔══██╗██║    ██╔══██╗██╔══██╗██╔═══██╗████╗ ████║██╔══██╗╚══██╔══╝██╔════╝
███████║██║    ██████╔╝██████╔╝██║   ██║██╔████╔██║██████╔╝   ██║   ███████╗
██╔══██║██║    ██╔═══╝ ██╔══██╗██║   ██║██║╚██╔╝██║██╔═══╝    ██║   ╚════██║
██║  ██║██║    ██║     ██║  ██║╚██████╔╝██║ ╚═╝ ██║██║        ██║   ███████║
╚═╝  ╚═╝╚═╝    ╚═╝     ╚═╝  ╚═╝ ╚═════╝ ╚═╝     ╚═╝╚═╝        ╚═╝   ╚══════╝
"
    echo "                    AI-Powered Prompt Operations by Annertech"
    echo ""

    # Select action
    local action_selection
    action_selection=$(select_action)
    if [[ -z "$action_selection" ]]; then
        echo_red "Nothing selected... Exiting"
        exit 0
    fi

    # Extract action from selection (remove number prefix)
    local action_label
    action_label=$(echo "$action_selection" | sed 's/^[0-9]*\. //')

    echo ""

    # Execute selected action
    case "$action_label" in
        "BackstopJS Init")
            backstop_init
            ;;
        *)
            echo_red "Unknown action: $action_label"
            exit 1
            ;;
    esac
}

main
