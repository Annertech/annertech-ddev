#!/usr/bin/env bash
#ddev-generated

# â”€â”€ Sanity check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
ddev sanity-check
if [[ $? -ne 0 ]]; then
  echo ""
  if [[ "$CURRENT_BRANCH" == "dev" ]]; then
    echo "âš ï¸  Sanity-check failed on 'dev' branch â€” pushing anyway."
  else
    read -p "âš ï¸  Sanity-check failed. Continue pushing anyway? (y/N): " sanity_confirm </dev/tty
    sanity_confirm=${sanity_confirm:-N}
    if [[ ! "$sanity_confirm" =~ ^[Yy] ]]; then
      echo "ğŸš« Push aborted: fix the issues above and try again."
      exit 1
    fi
  fi
fi

# â”€â”€ Backstop tests check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ -f "tests/backstop/backstop.json" ]; then
  BASE_DIR="tests/backstop/backstop_data/bitmaps_test"
  TODAY=$(date +%Y%m%d)
  MATCH=$(find "$BASE_DIR" -maxdepth 1 -type d -name "${TODAY}-*" 2>/dev/null)

  if [ -z "$MATCH" ]; then
    echo ""
    echo "=================================================================================================="
    echo "âš ï¸  No Backstop test folder found for today ($TODAY) in $BASE_DIR"
    echo "Did you run Backstop and other tests?"
    echo "=================================================================================================="
    echo ""
    read -p "Continue pushing without Backstop tests? (y/N): " backstop_confirm </dev/tty
    backstop_confirm=${backstop_confirm:-N}
    if [[ ! "$backstop_confirm" =~ ^[Yy] ]]; then
      echo "ğŸš« Push aborted. Run Backstop and other tests or use --no-verify to skip this check."
      exit 1
    fi
  fi
fi

exit 0
